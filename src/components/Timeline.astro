---
import { Briefcase, GraduationCap, MapPin, Sparkles, ChevronDown } from 'lucide-preact';
import { getCollection } from 'astro:content';

const allTimelineItems = await getCollection('timeline');

const timelineItems = allTimelineItems.map(item => ({
    ...item.data,
    uniqueId: item.id // Use collection ID
})).sort((a, b) => {
  const dateA = a.endDate === null || a.endDate === undefined ? '9999-12' : a.startDate;
  const dateB = b.endDate === null || b.endDate === undefined ? '9999-12' : b.startDate;
  return dateB.localeCompare(dateA); 
});

const getIconColor = (type) => {
    switch (type) {
      case 'work': return 'portfolio-navy';
      case 'education': return 'portfolio-royal-blue';
      default: return 'portfolio-navy';
    }
};
---

<section id="timeline" class="py-32 relative bg-white dark:bg-black transition-colors duration-300 overflow-hidden">
  <!-- Animated background elements -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-20 left-10 w-72 h-72 bg-portfolio-royal-blue/10 rounded-full blur-3xl animate-pulse-slow"></div>
    <div class="absolute bottom-20 right-10 w-96 h-96 bg-portfolio-navy/10 rounded-full blur-3xl animate-pulse-slower"></div>
  </div>

  <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-portfolio-navy to-transparent"></div>
  <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-gradient-to-r from-portfolio-navy via-portfolio-royal-blue to-portfolio-navy blur-sm"></div>

  <div class="max-w-6xl mx-auto px-6 relative z-10">
    <!-- Header -->
    <div class="text-center mb-16 animate-on-scroll">
      <div class="flex items-center justify-center mb-6">
        <div class="h-px w-16 bg-gradient-to-r from-transparent to-portfolio-navy/50"></div>
        <div class="mx-4 px-6 py-1 rounded-full border border-portfolio-navy/20 bg-gradient-to-r from-portfolio-navy/5 to-portfolio-royal-blue/5">
          <span class="text-xs font-medium tracking-widest uppercase text-portfolio-navy">Journey</span>
        </div>
        <div class="h-px w-16 bg-gradient-to-l from-transparent to-portfolio-royal-blue/50"></div>
      </div>

      <h2 class="text-4xl md:text-6xl font-bold text-black dark:text-white mb-6 tracking-tight">
        Experience & Education
      </h2>
      <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        From education to professional experience—here's my journey so far.
      </p>
    </div>

    <!-- Timeline Container -->
    <div class="relative">
      <!-- Vertical Line -->
      <div class="absolute left-8 md:left-1/2 top-0 bottom-0 w-0.5 bg-gradient-to-b from-portfolio-navy/30 via-portfolio-royal-blue/30 to-portfolio-navy/30 dark:from-portfolio-navy dark:via-portfolio-royal-blue dark:to-portfolio-navy"></div>
      
      <!-- Sparkle -->
      <div class="absolute left-8 md:left-1/2 top-0 transform -translate-x-1/2 animate-sparkle-move">
        <div class="animate-sparkle-pulse">
            <Sparkles class="text-portfolio-royal-blue" size={16} />
        </div>
      </div>

      <div class="space-y-12">
        {timelineItems.map((item, index) => {
            const isEven = index % 2 === 0;
            const iconColor = getIconColor(item.type);
            const Icon = item.type === 'work' ? Briefcase : GraduationCap;
            
            return (
                <div class={`relative flex items-start ${isEven ? 'md:flex-row' : 'md:flex-row-reverse'} flex-row animate-on-scroll ${isEven ? 'slide-left' : 'slide-right'}`}>
                    
                    <!-- Content Card -->
                    <div class={`flex-1 ${isEven ? 'md:pr-12 md:text-right' : 'md:pl-12 md:text-left'} pl-16 md:pl-0 text-left`}>
                        <div class="timeline-card group p-6 rounded-2xl bg-black/5 dark:bg-white/5 border-2 border-black/10 dark:border-white/10 shadow-lg relative transition-all hover:-translate-y-1 hover:shadow-xl">
                            
                            <!-- Logo Desktop -->
                            {item.logo && (
                                <a href={item.link} target="_blank" class={`hidden md:block absolute ${isEven ? 'md:left-4' : 'md:right-4'} top-4 group/logo z-10 hover:scale-110 hover:rotate-3 transition-transform`}>
                                   <div class="w-16 h-16 rounded-lg overflow-hidden">
                                     <img src={item.logo} alt={`${item.subtitle} logo`} class="w-full h-full object-contain" />
                                   </div>
                                </a>
                            )}

                            <!-- Badge -->
                            <div class={`inline-flex items-center gap-2 px-3 py-1 rounded-full mb-4 bg-portfolio-navy/10 dark:bg-portfolio-navy/20 border border-portfolio-navy/20 dark:border-portfolio-navy/30`}>
                                <span class={`text-xs font-medium text-${iconColor}`}>
                                    {item.duration}
                                </span>
                            </div>

                            <!-- Mobile Title Header -->
                            <div class="flex items-center gap-3 mb-2">
                                {item.logo && (
                                    <a href={item.link} target="_blank" class="md:hidden group/logo flex-shrink-0">
                                         <div class="w-12 h-12 rounded-lg overflow-hidden">
                                            <img src={item.logo} alt={`${item.subtitle} logo`} class="w-full h-full object-contain" />
                                         </div>
                                    </a>
                                )}
                                <h3 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">
                                    {item.title}
                                </h3>
                            </div>

                            <!-- Subtitle -->
                            <a href={item.link} target="_blank" class="group/link inline-block">
                                <h4 class={`text-lg font-semibold mb-2 group-hover/link:underline transition-all ${
                                    'text-' + iconColor // Note: dynamic class construction might need safeguarding, but explicit check above helps
                                }`}>
                                    {item.subtitle}
                                </h4>
                            </a>

                            <!-- Location -->
                            <div class={`flex items-center gap-2 mb-4 ${isEven ? 'md:justify-end' : 'md:justify-start'} justify-start`}>
                                <MapPin size={16} class="text-gray-600 dark:text-gray-400" />
                                <span class="text-sm text-gray-600 dark:text-gray-400">{item.location}</span>
                            </div>

                             <!-- Expand Button (Checkbox Hack or Just CSS Toggle? Let's use <details>) -->
                             <!-- Using <details> is semantic and built-in, but animation is tricky.
                                  Let's use a simple script for accordion logic to replicate current behavior. -->
                             <button
                                class="expand-btn flex items-center justify-center p-2 rounded-full mb-3 transition-all bg-black/5 hover:bg-black/10 dark:bg-white/5 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300 ml-0"
                                data-id={item.uniqueId}
                             >
                                <ChevronDown size={20} class="transform transition-transform duration-300" />
                             </button>

                             <div id={item.uniqueId} class="hidden overflow-hidden transition-all duration-300">
                                <ul class="space-y-2 pb-4">
                                    {item.items.map((desc) => (
                                        <li class={`text-sm text-gray-700 dark:text-gray-300 flex items-start gap-2 ${isEven ? 'md:flex-row-reverse md:text-right' : ''}`}>
                                            <span class={`text-${iconColor} mt-1`}>•</span>
                                            <span class="flex-1">{desc}</span>
                                        </li>
                                    ))}
                                </ul>
                             </div>
                        </div>
                    </div>

                    <!-- Center Icon -->
                    <div class="absolute left-8 md:left-1/2 top-0 transform -translate-x-1/2">
                        <div class={`w-16 h-16 rounded-full bg-gradient-to-br from-${iconColor}/30 to-${iconColor}/10 border-4 border-white dark:border-black shadow-lg flex items-center justify-center transition-transform hover:scale-125`}>
                            <Icon class={`text-${iconColor}`} size={24} />
                        </div>
                    </div>
                    
                    <!-- Spacer -->
                    <div class="hidden md:block flex-1"></div>
                </div>
            )
        })}
      </div>
    </div>
  </div>
</section>

<style>
  /* Reuse pulse animations from About */
  @keyframes sparkle-move {
     0% { top: 0%; visibility: visible; }
     99% { top: 99%; visibility: visible; }
     100% { top: 100%; visibility: hidden; }
  }
  .animate-sparkle-move {
     animation: sparkle-move 8s linear infinite;
  }
  .animate-sparkle-pulse {
     animation: pulse 2s infinite ease-in-out;
  }
  
  /* Text Colors - explicit for Tailwind to pickup? 
     Tailwind might purge 'text-portfolio-navy' if only constructed dynamically.
     Safelist common dynamic classes if needed. 
     Using style directives or safe listing in config is better. 
     For now, we know portfolio-navy and portfolio-royal-blue are used elsewhere so they are safe.
  */
  
  /* Accordion logic */
  .expanded .hidden { display: block; animation: slideDown 0.3s ease-out; }
  .expanded svg { transform: rotate(180deg); }
  
  @keyframes slideDown {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 500px; }
  }

  /* Scroll Animation Classes */
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }
  .animate-on-scroll.is-visible {
    opacity: 1;
    transform: translateY(0);
  }
  .slide-left { transform: translateX(-50px); }
  .slide-left.is-visible { transform: translateX(0); }
  .slide-right { transform: translateX(50px); }
  .slide-right.is-visible { transform: translateX(0); }

</style>

<script>
    // Accordion Logic
    document.querySelectorAll('.expand-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const button = e.currentTarget as HTMLButtonElement;
            const id = button.getAttribute('data-id');
            if (!id) return;
            const content = document.getElementById(id);
            if (!content) return;
            
            // Toggle visibility classes
            const icon = button.querySelector('svg') as unknown as HTMLElement;
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                // Optional: animate height
                if(icon) icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                if(icon) icon.style.transform = 'rotate(0deg)';
            }
        });
    });

    // Scroll Observer
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });

    document.querySelectorAll('.animate-on-scroll').forEach((el) => {
        observer.observe(el);
    });
</script>
