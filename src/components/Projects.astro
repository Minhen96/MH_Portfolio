---
import { Github, ExternalLink } from "lucide-preact";
import { getCollection } from "astro:content";

const allProjects = await getCollection("projects");
const projects = allProjects
  .sort((a, b) => a.data.order - b.data.order)
  .map((p) => p.data);
---

<section
  id="projects"
  class="py-32 relative bg-transparent transition-colors duration-300"
>
  <div class="max-w-6xl mx-auto px-6">
    <div class="flex items-center justify-center mb-6">
      <div
        class="h-px w-16 bg-gradient-to-r from-transparent to-portfolio-navy/50"
      >
      </div>
      <div
        class="mx-4 px-6 py-1 rounded-full border border-portfolio-navy/20 bg-gradient-to-r from-portfolio-navy/5 to-portfolio-royal-blue/5"
      >
        <span
          class="text-xs font-medium tracking-widest uppercase text-portfolio-navy"
          >Portfolio</span
        >
      </div>
      <div
        class="h-px w-16 bg-gradient-to-l from-transparent to-portfolio-royal-blue/50"
      >
      </div>
    </div>

    <h2
      class="text-4xl md:text-6xl font-bold text-black dark:text-white mb-20 text-center animate-fade-in tracking-tight"
    >
      Featured Projects
    </h2>

    <div class="grid lg:grid-cols-2 gap-10" data-projects-grid>
      {
        projects.map((project, index) => (
          <div
            class="group rounded-3xl overflow-hidden transition-all duration-500 animate-scale-in bg-[#0a0a0a] border-[3px] border-neutral-800 shadow-2xl flex flex-col"
            style={`animation-delay: ${index * 0.1}s`}
            data-project-card
            data-index={index}
          >
            {/* Multi-Image Gallery Container */}
            <div class="relative aspect-video w-full bg-neutral-900 overflow-hidden group/gallery">
              <div
                class="flex h-full overflow-x-auto overflow-y-hidden snap-x snap-mandatory no-scrollbar scroll-smooth touch-pan-x cursor-grab active:cursor-grabbing"
                data-scroll-container
              >
                {project.images.map((img, imgIdx) => (
                  <div class="flex-none w-full h-full snap-center relative">
                    {/* Blurred Background for mixed aspect ratios */}
                    <div
                      class="absolute inset-0 bg-cover bg-center blur-xl opacity-30 dark:opacity-20 scale-110"
                      style={`background-image: url(${img})`}
                    />

                    {/* Main Image */}
                    <img
                      src={img}
                      alt={`${project.title} screenshot ${imgIdx + 1}`}
                      class="relative w-full h-full object-contain z-10 transition-transform duration-700 group-hover/gallery:scale-[1.02] cursor-zoom-in"
                      loading="lazy"
                      data-lightbox-trigger
                      draggable="false"
                    />
                  </div>
                ))}
              </div>

              {/* Gallery Navigation Hints */}
              {project.images.length > 1 && (
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-1.5 z-20 pointer-events-none opacity-0 group-hover/gallery:opacity-100 transition-opacity duration-300">
                  {project.images.map((_, dotIdx) => (
                    <div
                      class="w-1.5 h-1.5 rounded-full bg-white/50 backdrop-blur-md transition-all duration-300"
                      data-dot
                    />
                  ))}
                </div>
              )}

              {/* Scroll Buttons */}
              {project.images.length > 1 && (
                <>
                  <button
                    class="absolute left-4 top-1/2 -translate-y-1/2 p-2.5 rounded-full bg-black/40 hover:bg-black/60 backdrop-blur-md text-white/90 hover:text-white transition-all shadow-lg active:scale-95 z-30 opacity-100 md:opacity-0 md:group-hover/gallery:opacity-100 hidden"
                    data-scroll-prev
                    aria-label="Previous image"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="m15 18-6-6 6-6" />
                    </svg>
                  </button>
                  <button
                    class="absolute right-4 top-1/2 -translate-y-1/2 p-2.5 rounded-full bg-black/40 hover:bg-black/60 backdrop-blur-md text-white/90 hover:text-white transition-all shadow-lg active:scale-95 z-30 opacity-100 md:opacity-0 md:group-hover/gallery:opacity-100"
                    data-scroll-next
                    aria-label="Next image"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="m9 18 6-6-6-6" />
                    </svg>
                  </button>
                </>
              )}

              <div
                class={`absolute bottom-0 left-0 right-0 h-1 z-30 bg-gradient-to-r ${index % 2 === 0 ? "from-portfolio-navy via-portfolio-royal-blue to-portfolio-navy" : "from-portfolio-royal-blue via-portfolio-navy to-portfolio-royal-blue"}`}
              />
            </div>

            <div class="p-8 flex flex-col flex-grow">
              <div class="flex justify-between items-start mb-2">
                <h3 class="text-2xl font-bold text-white tracking-tight leading-tight group-hover:text-portfolio-royal-blue transition-colors">
                  {project.title}
                </h3>
              </div>

              {/* Mobile Teaser Content (Collapsible) */}
              <div class="md:hidden space-y-4 mb-6" data-teaser-container>
                <p class="text-neutral-400 text-sm leading-relaxed line-clamp-2 italic opacity-80">
                  {project.description.split(" ").slice(0, 10).join(" ")}...
                </p>
                <div class="flex flex-wrap gap-1.5">
                  {project.techStack.slice(0, 3).map((tech) => (
                    <span class="px-2 py-0.5 rounded-md text-[9px] font-bold uppercase tracking-wider bg-white/5 text-neutral-300 border border-white/10">
                      {tech}
                    </span>
                  ))}
                  {project.techStack.length > 3 && (
                    <span class="text-[9px] text-neutral-500 font-medium self-center ml-1">
                      +{project.techStack.length - 3} more
                    </span>
                  )}
                </div>
              </div>

              {/* Full Details (Hidden on mobile initially, visible on desktop) */}
              <div
                class="project-details hidden md:block space-y-6 flex-grow"
                data-details-container
              >
                <p class="text-neutral-400 leading-relaxed text-sm">
                  {project.description}
                </p>

                <div class="mt-6 md:mt-auto">
                  <div class="flex flex-wrap gap-2 mb-6">
                    {project.techStack.map((tech) => (
                      <span class="px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider bg-white/5 text-neutral-300 border border-white/10">
                        {tech}
                      </span>
                    ))}
                  </div>

                  <a
                    href={project.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center space-x-2 px-6 py-3 rounded-xl border border-neutral-800 transition-all group/link hover:scale-105 text-neutral-300 hover:text-white hover:border-portfolio-royal-blue/50 hover:bg-portfolio-royal-blue/10 shadow-sm hover:shadow-md w-full md:w-auto justify-center md:justify-start"
                  >
                    <Github size={18} />
                    <span class="text-sm font-medium">View Source</span>
                    <ExternalLink
                      size={14}
                      class="group-hover/link:translate-x-1 transition-transform"
                    />
                  </a>
                </div>
              </div>

              {/* Mobile Toggle Button (Premium Gradient Border) */}
              <button
                class="md:hidden mt-6 group relative w-full overflow-hidden rounded-xl p-[1px] active:scale-[0.98] transition-transform duration-300"
                data-details-toggle
              >
                {/* Animated Gradient Border */}
                <div class="absolute inset-0 bg-gradient-to-r from-portfolio-navy via-portfolio-royal-blue to-portfolio-navy bg-[length:200%_auto] animate-shimmer opacity-50 group-hover:opacity-100 transition-opacity duration-500" />

                {/* Button Content */}
                <div class="relative h-full w-full bg-[#0c0c0c] rounded-xl flex items-center justify-center gap-2 py-3.5 transition-colors group-hover:bg-[#050505]">
                  <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-white/90 group-hover:text-white transition-colors">
                    Discover Project
                  </span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="3"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-portfolio-royal-blue group-hover:text-white transition-colors duration-300"
                  >
                    <path d="m6 9 6 6 6-6" />
                  </svg>
                </div>
              </button>
            </div>
          </div>
        ))
      }
    </div>

    {/* Lightbox Modal */}
    <div
      id="project-lightbox"
      class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-sm hidden flex-col items-center justify-center transition-opacity duration-300 opacity-0"
    >
      <button
        id="lightbox-close"
        class="absolute top-6 right-6 p-3 text-white/70 hover:text-white transition-colors z-[110] bg-black/20 rounded-full backdrop-blur-md"
        aria-label="Close lightbox"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"></path></svg
        >
      </button>

      <div
        class="relative w-full h-full flex items-center justify-center overflow-hidden"
      >
        <div
          id="lightbox-scroll-container"
          class="flex h-full w-full overflow-x-auto snap-x snap-mandatory no-scrollbar scroll-smooth cursor-grab active:cursor-grabbing touch-pan-y"
        >
          {/* Images will be injected here for the current project */}
        </div>

        {/* Lightbox Navigation */}
        <button
          id="lightbox-prev"
          class="absolute left-4 p-4 text-white/50 hover:text-white transition-colors bg-black/20 rounded-full backdrop-blur-md z-[110]"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg
          >
        </button>
        <button
          id="lightbox-next"
          class="absolute right-4 p-4 text-white/50 hover:text-white transition-colors bg-black/20 rounded-full backdrop-blur-md z-[110]"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg
          >
        </button>

        {/* Caption/Counter */}
        <div
          id="lightbox-counter"
          class="absolute bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full bg-black/40 backdrop-blur-md text-white/90 text-sm font-medium"
        >
          1 / 1
        </div>
      </div>
    </div>

    <script>
      // Show More Logic Removed - All projects visible by default

      // Show More Logic Removed - All projects visible by default

      // Mobile Project Details Toggle Logic REMOVED (Relies on Global Delegation below to prevent double-toggling)

      // Shared Drag-to-Scroll Logic
      const initDragScroll = (container: HTMLElement) => {
        let isDown = false;
        let startX: number;
        let scrollLeft: number;

        container.addEventListener("mousedown", (e) => {
          isDown = true;
          container.classList.add("active");
          startX = (e as MouseEvent).pageX - container.offsetLeft;
          scrollLeft = container.scrollLeft;
          container.style.scrollBehavior = "auto";
        });

        const stopDragging = () => {
          isDown = false;
          container.classList.remove("active");
          container.style.scrollBehavior = "smooth";
        };

        container.addEventListener("mouseleave", stopDragging);
        container.addEventListener("mouseup", stopDragging);

        container.addEventListener("mousemove", (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = (e as MouseEvent).pageX - container.offsetLeft;
          const walk = (x - startX) * 2;
          container.scrollLeft = scrollLeft - walk;
        });

        // Prevent dragging of any links/images inside to interfere
        container.querySelectorAll("img, a").forEach((el) => {
          el.addEventListener("dragstart", (e) => e.preventDefault());
        });
      };

      // Lightbox Logic
      const lightbox = document.getElementById(
        "project-lightbox",
      ) as HTMLElement;
      const lightboxScroll = document.getElementById(
        "lightbox-scroll-container",
      ) as HTMLElement;
      const closeBtn = document.getElementById("lightbox-close");
      const prevBtn = document.getElementById("lightbox-prev");
      const nextBtn = document.getElementById("lightbox-next");
      const counter = document.getElementById(
        "lightbox-counter",
      ) as HTMLElement;

      let currentGallery: string[] = [];
      let currentIndex = 0;

      initDragScroll(lightboxScroll);

      const openLightbox = (images: string[], index: number) => {
        currentGallery = images;
        currentIndex = index;

        // Inject images once for the specific project
        lightboxScroll.innerHTML = currentGallery
          .map(
            (img, i) => `
          <div class="flex-none w-full h-full snap-center flex items-center justify-center p-4">
            <img src="${img}" alt="Screenshot ${i + 1}" class="max-w-full max-h-full object-contain shadow-2xl rounded-lg pointer-events-none select-none" />
          </div>
        `,
          )
          .join("");

        updateLightbox(true);
        lightbox.classList.remove("hidden");
        setTimeout(() => lightbox.classList.add("opacity-100"), 10);
        document.body.style.overflow = "hidden";
      };

      const closeLightbox = () => {
        lightbox.classList.remove("opacity-100");
        setTimeout(() => {
          lightbox.classList.add("hidden");
          lightboxScroll.innerHTML = ""; // Cleanup
        }, 300);
        document.body.style.overflow = "";
      };

      const updateLightbox = (isInitial = false) => {
        const width = lightboxScroll.clientWidth;
        if (isInitial) {
          lightboxScroll.style.scrollBehavior = "auto";
          lightboxScroll.scrollLeft = currentIndex * width;
          lightboxScroll.style.scrollBehavior = "smooth";
        } else {
          lightboxScroll.scrollTo({
            left: currentIndex * width,
            behavior: "smooth",
          });
        }
        counter.textContent = `${currentIndex + 1} / ${currentGallery.length}`;

        // Smart Arrow Visibility
        if (currentGallery.length <= 1) {
          prevBtn?.classList.add("hidden");
          nextBtn?.classList.add("hidden");
          counter.classList.add("hidden");
        } else {
          prevBtn?.classList.toggle("hidden", currentIndex === 0);
          nextBtn?.classList.toggle(
            "hidden",
            currentIndex === currentGallery.length - 1,
          );
          counter.classList.remove("hidden");
        }
      };

      lightboxScroll.addEventListener("scroll", () => {
        currentIndex = Math.round(
          lightboxScroll.scrollLeft / lightboxScroll.clientWidth,
        );
        counter.textContent = `${currentIndex + 1} / ${currentGallery.length}`;
      });

      closeBtn?.addEventListener("click", closeLightbox);
      lightbox.addEventListener("click", (e) => {
        if (e.target === lightbox || e.target === lightboxScroll)
          closeLightbox();
      });

      prevBtn?.addEventListener("click", () => {
        currentIndex =
          (currentIndex - 1 + currentGallery.length) % currentGallery.length;
        updateLightbox();
      });

      nextBtn?.addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % currentGallery.length;
        updateLightbox();
      });

      // Gallery Logic (Scroll, Drag, Dots)
      document.querySelectorAll("[data-project-card]").forEach((card) => {
        const container = card.querySelector(
          "[data-scroll-container]",
        ) as HTMLElement;
        const button = card.querySelector(
          "[data-scroll-button]",
        ) as HTMLElement;
        const dots = card.querySelectorAll(
          "[data-dot]",
        ) as NodeListOf<HTMLElement>;
        const images = Array.from(
          card.querySelectorAll("[data-lightbox-trigger]"),
        ).map((img) => (img as HTMLImageElement).src);

        if (!container) return;

        initDragScroll(container);

        // Click to Scroll Logic
        const prevBtnInline = card.querySelector(
          "[data-scroll-prev]",
        ) as HTMLElement;
        const nextBtnInline = card.querySelector(
          "[data-scroll-next]",
        ) as HTMLElement;

        if (prevBtnInline) {
          prevBtnInline.addEventListener("click", () => {
            container.scrollBy({
              left: -container.clientWidth,
              behavior: "smooth",
            });
          });
        }
        if (nextBtnInline) {
          nextBtnInline.addEventListener("click", () => {
            container.scrollBy({
              left: container.clientWidth,
              behavior: "smooth",
            });
          });
        }

        // Gesture-Aware Lightbox Triggers
        card
          .querySelectorAll("[data-lightbox-trigger]")
          .forEach((trigger, idx) => {
            let startX = 0;
            let startY = 0;

            const handleStart = (e: MouseEvent | TouchEvent) => {
              const pos = "touches" in e ? e.touches[0] : e;
              startX = pos.pageX;
              startY = pos.pageY;
            };

            const handleEnd = (e: MouseEvent | TouchEvent) => {
              const pos =
                "changedTouches" in e ? e.changedTouches[0] : (e as MouseEvent);
              const diffX = Math.abs(pos.pageX - startX);
              const diffY = Math.abs(pos.pageY - startY);

              // Only trigger if it's a clean tap (minimal movement in any axis)
              // This prevents accidental triggers while vertical scrolling the page
              if (diffX < 10 && diffY < 10) {
                openLightbox(images, idx);
              }
            };

            trigger.addEventListener("mousedown", handleStart as EventListener);
            trigger.addEventListener("mouseup", handleEnd as EventListener);
            trigger.addEventListener(
              "touchstart",
              handleStart as EventListener,
              {
                passive: true,
              },
            );
            trigger.addEventListener("touchend", handleEnd as EventListener);
          });

        // Update dots and arrows on scroll
        const updateGalleryState = () => {
          const index = Math.round(
            container.scrollLeft / container.clientWidth,
          );
          const maxIndex = images.length - 1;

          dots.forEach((dot, i) => {
            const el = dot as HTMLElement;
            el.style.opacity = i === index ? "1" : "0.5";
            el.style.scale = i === index ? "1.2" : "1";
          });

          // Smart Arrow Visibility
          const prev = card.querySelector("[data-scroll-prev]") as HTMLElement;
          const next = card.querySelector("[data-scroll-next]") as HTMLElement;
          if (prev) prev.classList.toggle("hidden", index === 0);
          if (next) next.classList.toggle("hidden", index === maxIndex);
        };

        container.addEventListener("scroll", updateGalleryState);

        // Initial state
        updateGalleryState();
      });

      // Global Event Delegation for Project Details Toggle
      document.addEventListener("click", (e) => {
        const toggleBtn = (e.target as HTMLElement).closest(
          "[data-details-toggle]",
        );

        if (toggleBtn) {
          console.log("üéØ Clicked on Toggle Button (Delegated Listener)!");
          e.preventDefault();
          e.stopPropagation();

          const card = toggleBtn.closest("[data-project-card]");
          if (!card) {
            console.error("‚ùå No parent card found for toggle button");
            return;
          }

          const detailsContainer = card.querySelector(
            "[data-details-container]",
          ) as HTMLElement;
          const teaserContainer = card.querySelector(
            "[data-teaser-container]",
          ) as HTMLElement;
          const toggleIcon = toggleBtn.querySelector(
            "svg",
          ) as unknown as SVGElement;
          const btnText = toggleBtn.querySelector("span");

          if (detailsContainer) {
            const isHidden = detailsContainer.classList.contains("hidden");
            console.log(
              `Current state: ${isHidden ? "Hidden" : "Visible"}, toggling...`,
            );

            if (isHidden) {
              // Expand: Show Details, Hide Teaser
              detailsContainer.classList.remove("hidden");
              detailsContainer.classList.add("flex", "flex-col");
              teaserContainer?.classList.add("hidden");

              if (btnText) btnText.textContent = "Close Details";
              if (toggleIcon) toggleIcon.style.transform = "rotate(180deg)";

              // Scroll adjustment
              setTimeout(() => {
                const gallery = card.querySelector(".group\\/gallery");
                if (gallery) {
                  gallery.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                  });
                }
              }, 150);
            } else {
              // Collapse: Hide Details, Show Teaser
              detailsContainer.classList.add("hidden");
              detailsContainer.classList.remove("flex", "flex-col");
              teaserContainer?.classList.remove("hidden");

              if (btnText) btnText.textContent = "Discover Project";
              if (toggleIcon) toggleIcon.style.transform = "rotate(0deg)";

              // Scroll back to card top if needed
              card.scrollIntoView({
                behavior: "smooth",
                block: "nearest",
              });
            }
          } else {
            console.error("‚ùå No details container found");
          }
        }
      });
    </script>
  </div>
</section>

<style>
  .animate-fade-in {
    opacity: 0;
    animation: fadeIn 0.8s ease-out forwards;
  }

  .animate-scale-in {
    opacity: 0;
    transform: scale(0.95);
    animation: scaleIn 0.6s ease-out forwards;
  }

  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .animate-bounce-x {
    animation: bounce-x 1s infinite;
  }

  @keyframes bounce-x {
    0%,
    100% {
      transform: translateY(-50%) translateX(0);
    }
    50% {
      transform: translateY(-50%) translateX(5px);
    }
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }

  @keyframes scaleIn {
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>
